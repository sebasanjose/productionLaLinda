{% extends "base.html" %}
{% block title %}Market Results - La Linda Tracker{% endblock %}

{% block content %}
<div class="mb-4">
  <h1>Market Results</h1>
  <p class="text-muted">Record sales and reconcile inventory for market events.</p>
</div>

{% if event %}
<div class="card mb-4" style="border-left: 4px solid var(--primary-color);">
  <div class="flex justify-between align-center">
    <div>
      <h2 class="mb-0">{{ event.market_name }}</h2>
      <p class="text-muted">{{ event.event_date }}</p>
    </div>
    <div class="text-center" style="background: #f1f5f9; padding: var(--spacing-md); border-radius: var(--radius-md);">
      <span
        style="display: block; font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 600;">Total
        Cash</span>
      <span style="font-size: 1.5rem; font-weight: 700; color: var(--success-color);">
        {% if event.cash %}
        ${{ "%.2f"|format(event.cash) }}
        {% else %}
        <span style="color: var(--text-muted); font-size: 1rem;">--</span>
        {% endif %}
      </span>
    </div>
  </div>
</div>

<div class="grid grid-cols-2 gap-4">
  <!-- Record Sales Form -->
  <div class="card">
    <h3>üìù Record Sales Results</h3>
    <form method="POST">
      <div class="form-group">
        <label for="flavor_id">Flavor</label>
        <select name="flavor_id" id="flavor_id" required>
          {% for flavor in flavors %}
          <option value="{{ flavor.id }}">{{ flavor.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="grid grid-cols-3 gap-4">
        <div class="form-group">
          <label for="brought">Brought</label>
          <input type="number" name="brought" id="brought" step="0.1" min="0" required placeholder="0.0" />
        </div>
        <div class="form-group">
          <label for="sold">Sold</label>
          <input type="number" name="sold" id="sold" step="0.1" min="0" required placeholder="0.0" />
        </div>
        <div class="form-group">
          <label for="leftover">Leftover</label>
          <input type="number" name="leftover" id="leftover" step="0.1" min="0" required placeholder="0.0" />
        </div>
      </div>

      <button type="submit" class="btn btn-primary w-full">Record Results</button>

      <p class="text-muted text-sm" style="margin-top: var(--spacing-md);">
        <strong>Note:</strong> Sold + Leftover must equal Brought.
      </p>
    </form>
  </div>

  <!-- Record Cash Form -->
  <div class="card">
    <h3>üí∞ Record Cash</h3>
    {% if event.cash is none %}
    <form method="POST" action="{{ url_for('market_results', event_id=event_id) }}">
      <input type="hidden" name="record_cash" value="1" />
      <div class="form-group">
        <label for="cash_amount">Total Cash Received ($)</label>
        <input type="number" name="cash_amount" id="cash_amount" step="0.01" min="0" placeholder="0.00" required />
      </div>
      <button type="submit" class="btn btn-success w-full"
        style="background-color: var(--success-color); border-color: var(--success-color); color: white;">Record
        Cash</button>
    </form>
    {% else %}
    <div class="text-center" style="padding: var(--spacing-xl) 0;">
      <p class="text-muted">Cash has already been recorded for this event.</p>
      <p style="font-size: 1.5rem; font-weight: 700; color: var(--success-color); margin-top: var(--spacing-sm);">
        ${{ "%.2f"|format(event.cash) }}
      </p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Results Table -->
<div class="card mt-4">
  <h3>üìä Event Results Summary</h3>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Flavor</th>
          <th>Allocated</th>
          <th>Brought</th>
          <th>Sold</th>
          <th>Leftover</th>
        </tr>
      </thead>
      <tbody>
        {% if results %}
        {% for result in results %}
        <tr>
          <td>{{ result.name }}</td>
          <td>{{ "%.1f"|format(result.allocated or 0) }}</td>
          <td>{{ "%.1f"|format(result.brought or 0) }}</td>
          <td>{{ "%.1f"|format(result.sold or 0) }}</td>
          <td>{{ "%.1f"|format(result.leftover or 0) }}</td>
        </tr>
        {% endfor %}
        {% else %}
        <tr>
          <td colspan="5" class="text-center text-muted" style="padding: var(--spacing-xl);">
            No results have been recorded for this market event yet.
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

{% else %}
<div class="card" style="border-left: 4px solid var(--error-color);">
  <p class="text-muted">The specified market event could not be found.</p>
  <a href="{{ url_for('markets') }}" class="btn btn-secondary mt-4">Back to Markets</a>
</div>
{% endif %}
{% endblock %}